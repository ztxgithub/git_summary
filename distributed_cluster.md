# 分布式集群

## 集群

- 两大特性

``` shell

    1.可扩展性: 集群的性能是由多个相同服务实体构成的,新的服务实体可以动态地加入到集群,从而增强集群的性能
    2.高可用性: 集群通过服务实体冗余使客户端免于轻易遇到out of service的警告.即如果一台服务器崩溃了,可以切换到另外一台
                服务器,使得客户端的功能请求可以正常.
                	
```

- 两大能力

``` shell

    为了具有可扩展性和高可用性特点,集群的必须具备以下两大能力：
    
    1.负载均衡: 把任务比较均衡地分布到集群环境下的服务实体
    2.错误恢复: 由于某种原因,执行某个任务的资源出现故障,另一服务实体中执行同一任务的资源接着完成任务.
               这种由于一个实体中的资源不能工作，另一个实体中的资源透明的继续完成任务的过程叫错误恢复.
                	
```

- 两大技术

``` shell

   1.集群地址:客户端通过访问集群的集群地址获取集群内部各服务实体的功能.具有单一集群地址(也叫单一影像)是集群的一个基本特征.
             维护集群地址的设置被称为负载均衡器.负载均衡器内部负责管理各个服务实体的加入和退出,
             外部负责集群地址向内部服务实体地址的转换.
             
   2. 内部通信 : 为了能协同工作、实现负载均衡和错误恢复,集群各实体间必须时常通信,比如负载均衡器对服务实体心跳测试信息,
                服务实体间任务执行上下文信息的通信.
                
   具有同一个集群地址使得客户端能访问集群提供的计算服务,一个集群地址下隐藏了各个服务实体的内部地址,
   使得客户要求的计算服务能在各个服务实体之间分布.内部通信是集群能正常运转的基础,它使得集群具有均衡负载和错误恢复的能力.
                	
```

## 负载均衡

``` shell

     1.LB(Load Balance负载均衡器)
            LB负责分发设备的 MQTT连接与消息到 EMQ 集群,LB 提高 EMQ 集群可用性、实现负载平衡以及动态扩容.
            负载均衡器可以将来自多个公网地址的访问流量分发到多台主机上,并支持自动检测并隔离不可用的主机,
            从而提高业务的服务能力和可用性.你还可以随时通过添加或删减主机来调整你的服务能力,而且这些操作不会影响业务的正常访问.
            负载均衡器支持HTTP/HTTPS/TCP 三种监听模式,并支持透明代理,可以让后端主机不做任何更改就可以直接获取客户端真实IP.
            负载均衡器还支持灵活配置多种转发策略,实现高级的自定义转发控制功能.
            
            (1)均衡方式
                轮询：依据后端服务器的权重,将请求轮流发送给后端服务器,常用于短连接服务，例如 HTTP 等服务。
                
                最少连接：优先将请求发给拥有最少连接数的后端服务器,常用于长连接服务，例如数据库连接等服务。
                
                源地址：将请求的源地址进行hash运算,并结合后端的服务器的权重派发请求至某匹配的服务器,
                        这可以使得同一个客户端IP的请求始终被派发至某特定的服务器.该方式适合负载均衡无cookie功能的TCP协议.
                        
            (2)会话保持
                会话保持可以将来自同一个客户端的请求始终发给同一个后端服务器,是通过 cookie 的方式来实现的.
            
                植入cookie：由负载均衡器向客户端植入 cookie，这时你需要指定 cookie 的过期时间,不指定默认为不过期。
            
                改写cookie：cookie 由你的后端业务来植入和管理,负载均衡器会通过改写该 cookie 的值来实现会话保持,
                            改写cookie对后端服务是透明的,不会影响后端服务的正常运行；这时你需要指定需要改写的 cookie 名称.
                            
            (3)健康检查
                开启健康检测后,负载均衡器会根据你的配置定期检查后端服务的运行状态,当某个后端服务出现异常时,会自动隔离该后端服务,
                并将请求转发给其他健康的后端服务,实现高可用性。
            
                健康检查方式：
            
                    TCP：通过向后端服务器发送 TCP 包来检测后端服务
            
                    HTTP：通过向后端服务器发送HTTP请求来检测后端服务,你可以指定需要检测的URI.
                          负载均衡器会通过HTTP返回值是否为200来判断服务是否正常.
            
                健康检查选项：
            
                    检查间隔：连续两次健康检查之间的时间间隔，单位为秒，范围为 2 - 60s
            
                    超时时间：等待健康检查请求返回的超时时间，检查超时将会被判定为一次检查失败，单位为秒，范围为 5 - 300s
            
                    不健康阈值：多少次连续检查失败之后，可以将后端服务屏蔽，范围为 2 - 10次
            
                    健康阈值：多少次连续检查成功之后，可以将后端服务恢复，范围为 2 - 10次
                    
            (4)后端服务器权重
                当均衡方式为 “轮询” 时,你可以通过设置后端服务器的权重来让负载均衡器进行权重转发.权重的范围为 1 - 100,
                数值越大权重越高.
                
     2.四层、七层负载均衡
        四层就是基于IP+端口的负载均衡,七层就是基于URL等应用层信息的负载均衡,基于MAC地址的二层负载均衡和基于IP地址的三层负载均衡
        所谓的四到七层负载均衡,就是在对后台的服务器进行负载均衡时,依据四层的信息或七层的信息来决定怎么样转发流量.
        
        比如四层的负载均衡,就是通过发布三层的IP地址,然后加四层的端口号,来决定哪些流量需要做负载均衡,
        对需要处理的流量进行NAT处理(报文中目标IP地址进行修改(改为后端服务器IP)),转发至后台服务器,
        并记录下这个TCP或者UDP的流量是由哪台服务器处理的,后续这个连接的所有流量都同样转发到同一台服务器处理.
        此种Load Balance不理解应用协议（如HTTP/FTP/MySQL等等）.
        例子：LVS,F5
            Client->转发(修改报头目标地址+修改源地址根据需求)->server
        
        七层的负载均衡，就是在四层的基础上（没有四层是绝对不可能有七层的）,再考虑应用层的特征,
        比如同一个Web服务器的负载均衡,除了根据IP+80端口辨别是否需要处理的流量,还可根据七层的URL、浏览器类别、语言来决定
        是否要进行负载均衡.如果你的Web服务器分成两组,一组是中文语言的,一组是英文语言的,
        那么七层负载均衡就可以当用户来访问你的域名时,自动辨别用户语言,然后选择对应的语言服务器组进行负载均衡处理.
        Load Balancer能理解应用协议.例子： haproxy,MySQL Proxy.
        
        七层应用负载的好处,是使得整个网络更智能化.例如访问一个网站的用户流量,可以通过七层的方式,
        将对图片类的请求转发到特定的图片服务器并可以使用缓存技术,将对文字类的请求可以转发到特定的文字服务器并可以使用压缩技术.
        从技术原理上，这种方式可以对客户端的请求和服务器的响应进行任意意义上的修改,极大的提升了应用系统在网络层的灵活性.
        Nginx或者Apache上部署的功能可以前移到负载均衡设备上,例如客户请求中的Header重写,服务器响应中的关键字过滤或者内容插入等
        功能。
        另外一个常常被提到功能就是安全性.网络中最常见的SYN Flood攻击，即黑客控制众多源客户端,
        使用虚假IP地址对同一目标发送SYN攻击,通常这种攻击会大量发送SYN报文,耗尽服务器上的相关资源,
        以达到Denial of Service(DoS)的目的。从技术原理上也可以看出,四层模式下这些SYN攻击都会被转发到后端的服务器上；
        而七层模式下这些SYN攻击自然在负载均衡设备上就截止，不会影响后台服务器的正常运营.
        另外负载均衡设备可以在七层层面设定多种策略，过滤特定报文,例如SQL Injection等应用层面的特定攻击手段,
        从应用层面进一步提高系统整体安全.
        现在的7层负载均衡，主要还是着重于应用HTTP协议,所以其应用范围主要是众多的网站或者内部信息平台等基于B/S开发的系统。
         4层负载均衡则对应其他TCP应用，例如基于C/S开发的ERP等系统.
         
     3.负载均衡软件
        一种是通过硬件来进行,常见的硬件有比较昂贵的F5和Array等商用的负载均衡器,它的优点就是有专业的维护团队来对这些服务进行维护
        、缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有需要使用；
        另外一种就是类似于Nginx/LVS/HAProxy的基于 Linux的开源免费的负载均衡软件，这些都是通过软件级别来实现,
        所以费用非常低廉。
        
        目前关于网站架构一般比较合理流行的架构方案：Web前端采用Nginx/HAProxy+ Keepalived作负载均衡器；
        后端采用 MySQL数据库一主多从和读写分离,采用LVS+Keepalived的架构.
        
        Nginx的优点是：
            (1).工作在网络的7层之上,可以针对http应用做一些分流的策略,比如针对域名、目录结构,
            它的正则规则比HAProxy更为强大和灵活,这也是它目前广泛流行的主要原因之一,Nginx单凭这点可利用的场合就远多于LVS了.
            (2)Nginx对网络稳定性的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势之一；
                相反LVS对网络稳定性依赖比较大.
            (3)可以承担高负载压力且稳定,在硬件不差的情况下一般能支撑几万次的并发量,负载度比LVS相对小些.
            (4)Nginx可以通过端口检测到服务器内部的故障,比如根据服务器处理网页返回的状态码、超时等等,
                并且会把返回错误的请求重新提交到另一个节点,不过其中缺点就是不支持url来检测.
                比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障,Nginx会把上传切到另一台服务器重新处理，
                而LVS就直接断掉了
                
        Nginx的缺点是:
            (1)Nginx仅能支持http、https和Email协议,这样就在适用范围上面小些,这个是它的缺点.
            (2)对后端服务器的健康检查,只支持通过端口来检测,不支持通过url来检测.不支持Session的直接保持,但能通过ip_hash来解决.
            
        LVS的优点是:
            (1) 抗负载能力强、是工作在网络4层之上仅作分发之用,没有流量的产生,这个特点也决定了它在负载均衡软件里的性能最强的,
                对内存和cpu资源消耗比较低
            (2) 工作稳定,因为其本身抗负载能力很强,自身有完整的双机热备方案，如LVS+Keepalived.
            (3) 无流量,LVS只分发请求,而流量并不从它本身出去,这点保证了均衡器IO的性能不会受到大流量的影响
            (4) 应用范围比较广，因为LVS工作在4层，所以它几乎可以对所有应用做负载均衡，包括http、数据库、在线聊天室等等
            
        LVS的缺点是：
            (1) 软件本身不支持正则表达式处理,不能做动静分离；而现在许多网站在这方面都有较强的需求,
                这个是Nginx/HAProxy+Keepalived的优势所在.
            (2) 如果是网站应用比较庞大的话,LVS/DR+Keepalived实施起来就比较复杂了,
                特别后面有 Windows Server的机器的话,如果实施及配置还有维护过程就比较复杂了,
                Nginx/HAProxy+Keepalived就简单多了.
                
        HAProxy的特点是：
            (1) HAProxy的优点能够补充Nginx的一些缺点,比如支持Session的保持,Cookie的引导；
                同时支持通过获取指定的url来检测后端服务器的状态
            (2) HAProxy支持TCP协议的负载均衡转发,可以对MySQL读进行负载均衡,对后端的MySQL节点进行检测和负载均衡，
                大家可以用LVS+Keepalived对MySQL主从做负载均衡
                
            (3)HAProxy负载均衡策略非常多，HAProxy的负载均衡算法现在具体有如下8种：
               ① roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；
               ② static-rr，表示根据权重，建议关注；
               ③ leastconn，表示最少连接者先处理，建议关注；
               ④ source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法，建议关注；
               ⑤ ri，表示根据请求的URI；
               ⑥ rl_param，表示根据请求的URl参数’balance url_param’ requires an URL parameter name；
               ⑦ hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；
               ⑧ rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求.
               
               
        对网络负载均衡的使用是随着网站规模的提升使用不同的技术：
            第一阶段：利用Nginx或HAProxy进行单点的负载均衡,这一阶段服务器规模刚脱离开单服务器、单数据库的模式,
                    需要一定的负载均衡,但是仍然规模较小没有专业的维护团队来进行维护,也没有需要进行大规模的网站部署.
                    这样利用Nginx或HAproxy就是第一选择,此时这些东西上手快,配置容易,在七层之上利用HTTP协议就可以.
                    
            第二阶段：随着网络服务进一步扩大,这时单点的Nginx已经不能满足,这时使用LVS或者商用Array就是首要选择,
                    Nginx此时就作为LVS或者Array的节点来使用,具体LVS或Array的是选择是根据公司规模和预算来选择,
                    Array的应用交付功能非常强大,但是一般来说这阶段相关人才跟不上业务的提升,
                    所以购买商业负载均衡已经成为了必经之路.
                    
            第三阶段：这时网络服务已经成为主流产品,此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升,
                    这时无论从开发适合自身产品的定制,以及降低成本来讲开源的LVS,已经成为首选，这时LVS会成为主流.
                    
        最终形成比较理想的基本架构为：Array/LVS — Nginx/Haproxy — Squid/Varnish — AppServer。



               
            
        

        

                	
```

## 反向代理

``` shell

   1.反向代理：普通的代理设备是内网用户通过代理设备出外网进行访问,
                而工作在反向代理模式下的负载均衡设备,则是外网用户通过代理设备访问内网,因此称之为反向代理
                	
```