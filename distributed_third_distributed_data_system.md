# 分布式数据系统

## 分布式系统的挑战

### 故障与部分失效

```shell
    1. 在分布式系统中，可能会出现系统的一部分工作正常，但其他某些部分出现难以预测的故障，称之为“部分失效
    2. 分布式系统同时存在问题不确定性,例如网络问题,有时候网络正常,有时候网络异常.
    3. 云计算的特点: 多租户数据中心, 通用计算机, 用 IP 以太网连接, 弹性/按需资惊分配, 并按需计费。
    4. 低可靠性部件上构建高可靠的系统是分布式常用的方法,例如 IP(Internet 协议)层本身并不可靠，可能会出现丢包、
       延迟、重复发送以及乱序等情况。但 TCP(传输控制协议)在 IP 之上提供了更可靠的传输层，可以保证丢失的数据包被重传，
       消除重复包, 包的顺序以发送的顺序重新组合等.但 TCP/IP 的可靠性也是上限的,其不能解决网络延迟的问题.
```

### 不可靠的网络(网络问题)
```shell
    1. 网络中的节点请求没有收到响应,有 3 中可能,第一种: 请求丢失. 第二种: 远程结点异常(关闭). 第三种: 响应丢失.
       解决方案: 采用超时重发机制
    2. 检测故障
            (1) 如果出现了问题, 你可能会在远程的应用软件的收到一个关于错误的回复, 但最好假定最终收不到任何错误报告。
                接下来尝试重试, 等待超时之后，如果还是没有收到响应，则最终声明节点已经失效。
    3. 超时与无限期的延迟 
            (1) 当一个节点被认定为失效，其功能要交给到其他节点，这个过程会给其他节点以及网络带来额外负担，
                特别是如果此时系统已经处于高负荷状态.例如节点只是负载过高而出现响应缓慢，转移负载到其他节点可能会导致失效扩散，
                产生级联扩大效应.
    4. 网络拥塞与排队
            (1) 当多个不同节点同时发送数据包到相同的目标节点时，网络交换机会出现排队, 然后依次将数据包转发到目标网络。
                如果网络负载过重， 数据包可能必须等待一段时间才能获得发送机会（即网络拥塞）
                如果数据量太大，交换机队列塞满，之后的数据包则会被丢弃，网络还在运转，但会引发大量数据包重传。
            (2) 当数据包到达目标机器后，如果所有 CPU 核都处于繁忙状态， 则网络数据包请求会被操作系统排队， 直到应用程序能够处理
    5. 同步与异步网络
            (1) 同步网络,例如传统的固定电话网络, 会动态建立一条电路, 在整个线路上为呼叫分配一
                个固定的,带宽有保证通信链路，该电路一直维持到通话结束, 这个是不会受排队的影响.
                
                固定电话网络中的电路与 TCP 连接存在很大不同： 电路方式总是预留固定带宽，在电路建立之后其他人无法使用；
                而 TCP 连接的数据包则会尝试使用所有可用的网络带宽。TCP 可以传送任意大小可变的数据块（例如电子邮件或网页）,
                它会尽力在最短的时间内完成数据发送.而当 TCP 连接空闲时，通常不占用任何带宽.
                
                电路非常适合音频或视频通话，通话期间只需每秒传送固定数量的数据。
                
            (2) 异步网络, 采用了分组交换,针对突发流量进行了很多优化, 对于访问网页, 发送电子邮件或传输文件等无法事先确定带宽需求,
                只希望尽快发送完成. 对于突发数据的传输，电路网络无法充分利用网络容量，导致发送缓慢。 TCP 可以动态调整传
                输速率充分利用所有可用的网络容量.
            
```

### 不可靠的时钟
```shell
    1. 每台机器都有自己的本地时间,所有要保证多个机器之前的时间一致,常采用 NTP(Network Time Protocol),根据一组专门的时间服务器来
       调整本地时间, 时间服务器则从精确更高的时间源(如GPS 接收机)获取高精度时间.
    2. 单调时钟与墙上时钟
            (1) 墙上时钟(钟表时间), 根据某个日历(也称为墙上时间)返回当前的日期与时间。例如 Linux 的 
                clock_gettime(CLOCK_REALTIME), 返回自 1970 年 1 月 1 日( UTC )以来的秒数和毫秒数.
                墙上时钟可以与 NTP 同步, 这会导致系统时间的回拨现象, 原本本地时间远远快于 NTP 时间,但同步完后进行回拨,
                这种情况最好不要用来测量时间间隔.
            (2) 单调时钟, 更适合测量时间间隔, 例如超时或服务的响应时间： Linux 上的 clock_gettime(CLOCK_MONOTONIC),
                单调时钟保证永远向前,不会回拨.
    3. 时间同步与准确性问题, NTP 守护程序配置错误，防火墙阻止 NTP 通信等
    4. 依赖同步的时钟
            (1) 如果应用需要精确同步的时钟，需要监控所有节点上的时钟偏差。如果某个节点的时钟漂移超出上限， 
                应将其宣告为失效，并从集群中移除.这样可以今早减少重大问题.
            (2) 时间戳与事件顺序, 跨节点的事件排序(事件先后)，如果它高度依赖时钟计时·，就存在一定的技术风险(每个节点都有各自的时钟),
                在统一的维度,可能在节点一先发的事件到节点三时检查事件的源时间(从节点一取), 要晚于后发的节点二到达节点三(因为节点二的
                时钟要远小于节点一的时钟). 对于这种有先后顺序的事件,通常可以采用递增计数器而不是取源时间.
```



