# hik ehome

## 简介

```shell
ehome 协议：
    (1) 取流类接口,预览、停止预览、强制I帧、回放、倒放、停止回放、暂停、重新播放、快/慢放、绝对时间回放、下载。Ehome取流按协议区分有TCP、UDP
     
     a. UDP/TCP 预览:  
         Meida模块导入Ehome取流插件动态库，下发TCP预览到Ehome取流插件，ehome取流插件从端口池中选择一个可用的TCP端口，本地绑定端口地址，开启tcp端口监听，
     通过ldm->PluginFrame将地址信息发送给ehome驱动，然后ehome驱动通过ehome协议发送给ehome代理，代理内部调用ehomesdk接口与设备进行交互。设备根据地址信息，
     向ehome插件发起TCP连接，连接成功后推送码流数据，ehome插件将码流数据回调给媒体服务。
    
     TCP端口机制：端口范围由media配置下发，ehome插件从中选取空闲端口。
    
     b. TCP回放
     Meida模块导入Ehome取流插件动态库，下发TCP回放到Ehome取流插件，ehome取流插件根据媒体传送的回放起止时间，先查询时间段内的录像文件(这个作用先让设备产生录像文件，以便后续在
        进行回放进行相关时间内的录像码流数据的传输)，
        将查询信令发送到ehome驱动，ehome驱动发送到ehome代理，ehome代理调用ehomesdk向设备查询录像文件，并且逐步返回给ehome取流插件查询到的录像文件。
     Ehome取流插件再选择录像文件，通过信令将地址信息，录像回放时间信息发送给ehome驱动，然后ehome驱动通过ehome协议发送给ehome代理，ehome代理调用ehomsdk接口与ehome设备进行通信。
     设备根据地址信息，向ehome插件发起TCP连接，连接成功后推送录像码流数据，ehome插件将码流数据回调给媒体服务
    
     c. 抓图类
     Ehome 抓图由上层应用发起，ehome代理将抓图请求发送到设备，设备负责上传图片到指定url(在此之前需要配置图片服务器)，并响应
    
    (2) .
     a. 常规信令网络传输协议： UDP, 设备端需要循环接收 UDP 数据包来执行服务器下发的指令
     b.多媒体数据网络传输协议： TCP, 例如预览，回放，升级（HTTP），使用 TCP 短连接传输数据
     c.通用信令格式： XML (UTF-8编码)
     d.单条信令长度： 最大1500字节
     e.默认注册端口： 7660
     
    (3) 
        EHOME信令分八个子模块：
        1.注册/注销（REGISTER）：平台与设备之间的登录，注销
        2.控制（CONTROL）：控制设备功能（心跳，抓图，重启，升级等）
        3.查询（QUERY）：查询设备相关信息（能力集，录像，图片等）
        4.流媒体（MEDIA）：平台获取设备多媒体信息（预览，回放，语音对讲等）
        5.告警上报（ALARM）：设备上传报警消息（按键报警，DBA/人脸告警等）
        6.数据传输（DATA）：设备上传图片数据（图片数据，透传数据）
        7.消息上报（MESSAGE）：设备上传状态数据（GPS等）
        8.参数配置（PARAM）：平台获取和设置设备参数（录像参数，DBA参数等）
        
        a. 注册流程
                (1).设备将设备信息拼装成 XML 注册报文，发送给平台 PAG（设备接入网关服务器）
                (2).PAG 解析设备注册 XML 报文后，返回注册答复报文(里面包含是图片服务信息, 报警服务器信息)
                (3) 设备解析注册答复报文，将返回信息保存到设备本地（图片服务器，人脸服务器，报警服务器等信息）
                (4) 设备注册流程结束，在平台在线（G4的4G灯会变成常亮状态）
        b. 控制（CONTROL）
               (1) 心跳命令（设备->平台）：设备定期发送心跳包给平台，心跳间隔由平台下发心跳间隔指令决定，默认15s，
                                       当超过一定周期平台未接收到设备心跳报文，平台认为设备已离线，所有通信链路断开
               (2) 升级命令（平台->设备） ：平台先下发XML升级请求报文，里面含有升级包 HTTP/HTTPS 地址，设备接收并解析请求包后，
                                        调用 CURL 库 HTTP/HTTPS 下载 HTTP 升级包
               (3) 抓图：平台下发抓图 XML 指令，设备根据指令中的通道号，分辨率，上传标志位抓图并上传平台
        c. 告警上报
               (1) 当设备发生异常或报警事件时，会主动发送报警消息到 AMS（平台报警服务器），通信方式的 UDP
                   通常报警除了报警报文以外，设备还会推送报警图片和报警视频发送给平台，由于两者是异步上传，
                   所以需要一个报警字段绑定报警报文和多媒体数据，EHOME 协议中规定 PicID 和 VideoId 作为报警联动图片和
                   报警联动视频的唯一标识






```