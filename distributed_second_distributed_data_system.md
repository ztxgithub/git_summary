# 分布式数据系统

## 概要
```shell
    1. 分布式系统部署目的
        (1). 扩展性，当数据量和负载超过了单机处理上限，需要将负载分散到多台机器上。
        (2). 容错和高可用，单点故障会导致系统不可用，需要多台机器进行冗余。
        (3). 延迟考虑，客户可以访问最近数据中心提供的服务，降低响应的延迟。
    2. 复制和分区
        将数据分布到多个节点的方式有"复制"和"分区"。「复制」是在多个节点保存相同的数据，达到数据冗余，使得系统可用，
        同时也可以提高系统的性能。「分区」将大数据分到不同的节点。
```

## 数据复制
```shell
    1. 复制势必涉及到变化数据的同步问题。通常有 3 中方案，第一种主从复制。第二种多主节点复制。第三种无主节点复制。
    2. 复杂过程中的问题。
           (1). 采用同步复制还是异步复制。
           (2). 如何复制失败的副本
```

### 主从复制
```shell
    1. 主从复制的原理
            「第一步」指定一个副本为主副本（主节点），当客户端写数据库时，必须将写请求发生到主副本，主副本将新数据写到自己的本地存储。
            「第二步」其他副本为从副本（从节点），主副本将数据更新到自己的本地存储后，再将数据更改作为复制的日志或者
            更改流发生给其他从副本，从副本根据日志内容进行进行相应的操作，其写入的顺序与主副本要严格保持一致。
            「第三步」当客户端读数据库中数据时，直接去从副本进行读取。只有主副本才能接受写请求。
    2. 主从复制应用范围很广，关系型数据库：PostgreSQL, MySQL. 非关系型数据库：MongoDB,RethinkDB。
       分布式消息队列：Kafka, rabbitmq.
    3. 同步复制与异步复制，同步复制是主副本阻塞等待从副本的更新成功。同步复制的优点：一旦同步复制成功，则主从副本数据一致，
       都是最新的数据，所以客户端从数据库读的都是最新数据（不管是从主副本还是从副本）。同步复制的缺点：如果从副本无法及时完成
       同步（从副本节点崩溃，网络延迟），那么写入就不能视为成功。主副本就一直阻塞导致后续写入操作无法进行。
       所以系统一般不会将所有节点设置为同步复制，所以数据库「同步复制设置」的选项就是半同步模式，只将一个节点作为同步复制，
       其他节点作为异步复制。
    4. 增加新的从节点，保证新的从节点数据与主节点数据保持一致。简单的常规数据文件拷贝会导致不同的节点呈现不同的时间点数据，
       因为在这种拷贝方式过程中有数据写入更新操作。
       正常的逻辑过程：
            「第一步」在某个时间点对主节点的副本数据产生一致性快照。
            「第二步」将该快照拷贝到新的从副本节点上。
            「第三步」从节点连接主节点并请求该节点对应的快照之后的更新数据日志（内部的原理是在创建快照时，
                    快照与系统复制日志的位置保持关联）。
            「第四步」从节点在快照之后根据日志进行数据的更新。这个过程称为追赶。
    5. 处理节点失效情况。
            (1). 从节点失效，使用追赶式恢复。从节点的本地磁盘会保留副本收到的数据变更日志。那么在从节点恢复时就可以根据本地的更新日志
                 向主节点请求故障之后的数据。
            (2). 主节点失效，节点切换。判断主节点是否失效，通常采用超时的机制，各个节点间互发心跳包，如果主节点没有响应，
                 则认为主节点失效了。接下来进行选举（通过超过多数的节点共识），主要在从节点中选举出一个作为新的主节点，
                 该节点最好与旧的主节点数据差异小，同时客户端以后写请求都有路由到新的主节点中（请求路由），
                 其他节点接受来着新的主节点的变更数据。这时如果原来的主节点重新上线，系统要使其降为从节点.
    6. 主节点失效时进行节点切换存在的问题
            (1) 当使用了异步复制，并且在失效之前，新的主节点并没有收到原主节点的所有数据．这时如果原主节点恢复重新
            　　 加入到集群中，新的主节点会收到冲突的写请求，因为原主节点还未意识到角色的变化，还向其他的节点同步
            　　　消息．常见的解决方案是，原主节点上未完成复制的写请求丢弃，这可能会违背数据更新持久化的特性。
```

