# Linux 流量控制

- 什么是流量控制

``` shell

     流量控制就是在路由器上通过一系列队列，对数据包进行排序以控制它们的发送顺序，并通过一系列策略控制收到的和发送的数据包是否应该被丢弃，
     同时还要对数据包的发送速率进行控制.
     QoS（Quality of Service，服务质量）通常也被当做是一种实施流量控制的方法.
```

[参考资料](http://www.wy182000.com/wordpress/wp-content/uploads/2013/04/overview.html)

- 令牌桶

``` shell

    系统以一定的速率产生令牌，每个数据包（或一个字节）对应一个令牌，只有当令牌充足的时候数据包才能出队.
    打个比方来说,在游乐园里有很多游客在排队等待乘坐过山车。让我们假设过山车按照固定的时间到来。游客必须等待一列过山车到来后才能乘坐。
    在这里，过山车上的位置就相当于令牌，而游客就相等于数据包。这就是网络速率限制，或者称为shaping。在单位时间内，
    只能有固定数量的游客乘上过山车（出队）。继续这个过山车的比喻，假设某个时刻没有游客排队，而车站里有很多车子，这时候来了一大波游客，
    那么这些游客的大多数人（甚至是全部）都能立刻乘上过山车（因为此时车站里有很多空车）。车站里所能停放的过山车数量就是令牌桶中“桶”的大小。
    桶中积攒起来的令牌能在突然出现大量数据包时全部使用出去。
    让我们完成这个比喻。游乐园里的过山车以恒定速率到来，如果没有游客排队的话，就停放在等待区里，直到等待区里停满了车子。
    在令牌桶模型中，令牌以恒定的速率填充到桶中，直到桶满了为止。使用令牌桶模型进行流量整形能应付诸如HTTP应用之类会产生突发数据传输的情形.
    
    一个装满的令牌桶能在一定时间内应付任何类型的流量。比较恒定的网络流量适合使用较小的令牌桶。
    经常有突发数据传输的网络则比较适合使用大的令牌桶，除非流量整形的目的是为了限制突发数据传输(这种情况适合emqttd服务器).
    
    令牌桶模型也被应用于TBF（一种classless qdiscs）和HTB（一种classful qdiscs）中。
```

## 流量控制中的概念

- 令牌桶

``` shell
    1.整形(shaping)
        整形就是流量控制，把数据包的发送速率控制在一个固定的水平以下,由于整形通过延迟数据包的发送来控制数据包发送速率，
        故整形机制是非工作保存的。“非工作保存”可以理解为：系统必须进行一些操作来延迟数据包的发送。反过来说，
        一种非工作保存的队列是可以进行流量整形的，而工作保存的队列（参考 PRIO）不能进行流量整形，因为工作保存队列无法延迟发送数据包.
        在流量整形中，通常会使用令牌桶机制来实现整形.
        
    2.调度(scheduling)
        一个调度器会对将要发送的数据包顺序进行排列或重排。最常见的调度器是FIFO（先入先出队列）。由于数据包必须按顺序出队，
        因此队列实际上就是一个调度器。对于不同的网络环境，我们可以使用不同的调度器。
        一个公平队列算法（参考SFQ）能防止一个客户端或一个数据流占用过多的带宽。
        一个循环算法（参考WRR）可以让各个客户端或数据流都有平等的使用网络的机会。还有一些更复杂的算法可用于防止骨干网流量过载
        
    3.分类(classifying)
        分类器能把不同类型的网络流量划分到不同的队列中去。通常我们只对上行流量进行分类。在路由器接收、路由并转发一个数据包的时候，
        网络设备可以以几种不同的方式给数据包进行分类。其中一种方式是标记数据包。标记数据包的操作可以在一个网络中由管理员进行设置，
        也有可能在数据包经过每一跳时发生。
        Linux允许数据包通过一系列的流量控制结构，期间允许用户使用决策器对数据包进行分类（参考第 4.3 节 “过滤器”和第 4.5 节 “决策器”）.
        
    4.策略(policing)
        决策器能计算并限制某个特定队列的流量。在流量控制中使用决策器来控制流量是非常简单的。决策器通常会应用于网络边界上，
        某个节点使用的流量不会超过分配给它的流量。当网络流量在预设值以下时，决策器什么都不会做。但当网络流量超过预设值时，
        决策器就开始发挥作用，它能将流量速率控制在一个固定的水平之下。最不近人情的操作是即使在数据包能够继续分类的情况下依旧直接将其丢弃。
        决策器只会区别对待两种情况，分别是入队数据包速率高于或低于预定速率。当入队速率低于预设值时，决策器就会允许数据包入队。
        当入队速率高于预设值时，决策器就执行其他操作（丢包或重新分类）。虽然决策器内部使用令牌桶来计算速率，
        但它并不像shaping(整形)那样会延迟数据包的发送
        
    5.标记(marking)
        标记是一种对数据包进行一些修改的操作.流量控制中的标记操作会给数据包加上一个DSCP，
        接下来在由一个管理员控制的一个网络下的其他路由器上将会使用这个标记.
```

## Linux流量控制中的组件