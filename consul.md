# Consul 

## 简介

```shell
  1.  Consul 是一个支持多数据中心分布式高可用的服务发现和配置共享的服务软件， 一致性协议采用 Raft 算法,用来保证服务的高可用
  2.  Consul 的使用场景
        (1) docker 实例的注册与配置共享, coreos 实例的注册与配置共享
        (2) SaaS 应用的配置共享
  3. Consul 的优势
        (1) 使用 Raft 算法来保证一致性, 比复杂的 Paxos 算法更直接. zookeeper 采用的是 Paxos, etcd 采用的是 Raft.
        (2) 支持多数据中心，内外网的服务采用不同的端口进行监听。 多数据中心集群可以避免单数据中心的单点故障,而其部署则需要考虑网络延迟, 分片等情况等. 
            zookeeper 和 etcd 均不提供多数据中心功能的支持.
        (3) 支持健康检查. etcd 不提供此功能.
        (4) 支持 http 和 dns 协议接口. zookeeper 的集成较为复杂, etcd 只支持 http 协议.
        (5) 官方提供 web 管理界面, etcd 无此功能.
  4. 功能
      (1) 服务发现：Consul client 可以提供服务，例如 api 或 mysql，也可以使用 Consul client 来发现指定服务的提供者。 
                  consul通过 DNS 或者 HTTP 接口使服务注册和服务发现变的很容易。
      (2) 健康检查：Consul client 可以提供任何数量的健康检查，或者与给定的服务（“Web服务器是否返回 200 OK”），或与本地节点（“内存利用率是否低于90％”）相关联。
                   可以使用此信息来监控集群运行状况，服务发现组件使用这些信息把相关的请求不再发到有问题的主机中.、
      (3) KV Store：应用程序可以使用 Consul 的分层键/值存储，包括动态配置，功能标记，协调，leader选举等等。 简单的 HTTP API 使其易于使用
  5. 基本架构
      (1) 向 Consul 提供服务的每个节点都运行一个 Consul 代理。 发现其他服务, 获取(设置)键/值数据不需要运行代理。代理负责检查节点上的服务健康状态以及节点本身。
　　      代理与一个或多个 Consul 服务器通信。Consul 服务器是数据存储和复制的地方。 服务器自己选出一个 leader。 虽然 Consul 可以在一台服务器上运行，
          但推荐使用 3 到 5 台来避免数据丢失的情况。 每个数据中心都建议使用一组 Consul 服务器。 需要发现其他服务或节点的基础架构组件可以查询
          任何 Consul 服务器或任何 Consul 代理。 代理自动将查询转发到服务器。每个数据中心都运行 Consul 服务器集群。 当跨数据中心服务发现或配置请求时，
          本地 Consul 服务器将请求转发到远程数据中心并返回结果。
      (2) consul 在构建服务发现系统中，其客户端只需注册服务，然后使用 DNS 或 HTTP 接口执行发现。服务发现框架必须包含健康检查和失败的可能性
      (3) 部署方面: consul 部署的时候分 server 节点和 client 节点（通过不同的启动参数区分），server 节点做 leader 选举和数据一致性维护，
                   client 节点部署在服务机器上，作为服务程序访问 consul 的接口。
  6. zookeeper 和 consul 比较
      (1) 链接方式上, zookeeper client api 和服务器保持长连接，需要服务程序自行管理和维护链接有效性，服务程序注册回调函数处理 zookeeper 事件，
          并自己维护在 zookeeper 上建立的目录结构有效性（如临时节点维护）；consul 采用 DNS 或者 http 获取服务信息，没有主动通知，需要自己轮训获取
      (2) 工具方面，zookeeper 自带一个 cli_mt 工具，可以通过命令行登录 zookeeper 服务器，手动管理目录结构。
          consul 自带一个 Web UI 管理系统， 可以通过参数启动并在浏览器中直接查看信息。
  7. 组成
      (1) client 节点
          负责转发所有的 RPC 到 server 节点。本身无状态，且轻量级，本身是不持久化这些信息, 可以部署大量的 client 节点
      (2) server 节点
          负责组成 cluster 的复杂工作（选举、状态维护、转发请求到 lead），以及 consul 提供的服务（响应 RCP 请求）。
          考虑到容错和收敛，一般部署 3 ~ 5 个比较合适。这种模式下，功能和CLIENT都一样，唯一不同的是，它会把所有的信息持久化的本地
      (3) 代理(agent)：代理是 Consul 集群上每个成员的守护进程，它是由 consul agent 开始运行, 代理能够以客户端或服务器模式运行。由于所有节点都必须运行代理，
          所以将节点引用为客户端或服务器更为简单，但还有其他实例的代理。所有代理可以运行 DNS 或 HTTP 接口，并负责运行检查和保持服务同步。
          

```